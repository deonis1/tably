/*jshint esversion: 8 */
/* Copyright (c) 2023 Denis Spasyuk, MIT License*/
function tably(t,e){this.data=t,this.options=e,this.className=e.className||"",this.hiddenColumns=e.hiddenColumns||[],this.hideFilters=e.hideFilters||!1,this.checkBoxesCol=this.options.checkBoxes||!0,this.hideSearch=e.hideSearch||!1,this.customParser=e.customParser||null,this.customFooterButtons=e.customFooterButtons||[],this.customHeaderButtons=e.customHeaderButtons||[],this.allKeys=e.allKeys||this.getUnifiedKeys(),this.selectedRowdata={},this.renderModalEdit=e.renderModalEdit||function(){},this.init()}tably.prototype.getUnifiedKeys=function(){const t=new Set;return this.data.forEach((e=>{for(const a in e)t.add(a)})),Array.from(t)},tably.prototype.init=function(){this.table=document.createElement("table"),this.table.className=`table ${this.className}`,this.currentPage=1,this.perPage=this.options.perPage||10,this.totalPages=this.data.length/this.perPage<1?1:Math.ceil(this.data.length/this.perPage),this.sortColumn=null,this.sortOrder="asc",this.filterColumns=this.options.filterColumns||[],this.filteredData=this.data.slice(),this.createTableHeader(),this.createTableBody(),this.createTableFooter(),this.updatePaginationInfo()},tably.prototype.reloadData=function(){this.filteredData=this.data.slice(),this.currentPage=1,this.createTableBody()},tably.prototype.createTableHeader=function(){const t=document.createElement("thead");t.className="thead-light";const e=document.createElement("tr"),a=document.createElement("tr");if(this.checkBoxesCol){const t=document.createElement("th");t.className="tably-checkbox-header";const n=document.createElement("input");n.type="checkbox",n.addEventListener("change",(t=>{this.table.querySelectorAll('tbody input[type="checkbox"]').forEach((e=>{e.checked=t.target.checked}))})),t.appendChild(n),e.insertBefore(t,e.firstChild);const o=document.createElement("th");a.insertBefore(o,a.firstChild)}const n=document.createElement("colgroup"),o=document.createElement("colgroup");for(const t of this.allKeys)if(!this.hiddenColumns.includes(t)){const s=document.createElement("col");n.appendChild(s);const i=document.createElement("col");o.appendChild(i);const r=document.createElement("th");r.innerText=t,r.addEventListener("click",(()=>{this.sortData(t)})),e.appendChild(r);const l=document.createElement("th"),c=document.createElement("input");c.type="text",c.className="form-control form-control-sm",c.placeholder="Filter...",c.dataset.column=t,c.addEventListener("input",(t=>{this.filterData(t.target.dataset.column,t.target.value)})),this.hideFilters||l.appendChild(c),a.appendChild(l)}t.appendChild(n),t.appendChild(e),this.hideFilters||(t.appendChild(o),t.appendChild(a)),this.table.appendChild(t)},tably.prototype.createTableBody=function(){const t=document.createElement("tbody"),e=(this.currentPage-1)*this.perPage,a=this.currentPage*this.perPage;for(let n=e;n<a&&n<this.filteredData.length;n++){const e=document.createElement("tr");if(e.dataset.id=this.filteredData[n].id,this.checkBoxesCol){const t=document.createElement("td");t.className="tably-checkbox-cell";const a=document.createElement("input");a.type="checkbox",a.dataset.index=n,t.appendChild(a),e.appendChild(t)}this.allKeys.forEach((t=>{if(!this.hiddenColumns.includes(t)){const a=document.createElement("td");let o=this.filteredData[n][t]||"";this.customParser&&(o=this.customParser(t,o)),a.innerText=o,a.dataset.key=t,e.appendChild(a)}})),t.appendChild(e)}this.table.tBodies[0]?this.table.replaceChild(t,this.table.tBodies[0]):this.table.appendChild(t),this.addRowListeners()},tably.prototype.createTableFooter=function(){this.footer=document.createElement("div"),this.footer.className="tably-table-footer",this.footerPage=document.createElement("div"),this.footerPage.className="tably-table-footer-page",this.footerButtons=document.createElement("div"),this.footerButtons.className="tably-table-footer-buttons",this.footerInfo=document.createElement("div"),this.footerInfo.className="tably-table-footer-info",this.currentPageSpan=document.createElement("span"),this.currentPageSpan.className="tably-current-page",this.currentPageSpan.textContent=this.currentPage||1,this.totalPagesSpan=document.createElement("span"),this.totalPagesSpan.className="tably-total-pages",this.totalPagesSpan.textContent=this.totalPages||1;const t=document.createElement("button");t.innerHTML='<i class="fas fa-chevron-left"></i>',t.className="btn btn-secondary btn-sm mr-2",t.title="Previous";const e=document.createElement("button");e.innerHTML='<i class="fas fa-chevron-right"></i>',e.className="btn btn-secondary btn-sm",e.title="Next",t.addEventListener("click",(()=>{this.previousPage(),this.updatePaginationInfo()})),e.addEventListener("click",(()=>{this.nextPage(),this.updatePaginationInfo()})),this.customFooterButtons.forEach((t=>{const e=document.createElement("button");e.innerHTML=t.icon?`<i class="${t.icon}"></i> `:"",e.innerHTML+=t.text,e.title+=t.title?t.title:"",e.className=`btn ${t.className||"btn-secondary btn-sm "} mr-2`,e.addEventListener("click",t.action),this.footerButtons.appendChild(e)})),this.footerPage.appendChild(t),this.footerPage.appendChild(e),this.footerPage.insertBefore(this.currentPageSpan,e),this.footerPage.insertBefore(document.createTextNode(" / "),e),this.footerPage.insertBefore(this.totalPagesSpan,e),this.footer.appendChild(this.footerButtons),this.footer.appendChild(this.footerPage),this.footer.appendChild(this.footerInfo)},tably.prototype.updatePaginationInfo=function(){this.currentPageSpan.textContent=this.currentPage||1,this.totalPagesSpan.textContent=this.totalPages||1},tably.prototype.sortData=function(t){this.sortColumn=t,this.sortOrder="asc"===this.sortOrder?"desc":"asc",this.filteredData.sort(((e,a)=>e[t]<a[t]?"asc"===this.sortOrder?-1:1:e[t]>a[t]?"asc"===this.sortOrder?1:-1:0)),this.createTableBody()},tably.prototype.filterData=function(t,e,a=!1){this.filteredData=this.data.filter((n=>{if(a){for(let t in n)if(null!=n[t]&&n[t].toString().toLowerCase().includes(e.toLowerCase()))return!0}else if(null!=n[t]&&n[t].toString().toLowerCase().startsWith(e.toLowerCase()))return!0;return!1})),this.currentPage=1,this.createTableBody()},tably.prototype.previousPage=function(){this.currentPage>1&&(this.currentPage--,this.createTableBody())},tably.prototype.nextPage=function(){const t=Math.ceil(this.filteredData.length/this.perPage);this.currentPage<t&&(this.currentPage++,this.createTableBody())},tably.prototype.addRowListeners=function(){this.table.tBodies[0].querySelectorAll("tr").forEach((t=>{t.addEventListener("dblclick",(()=>{const e=t.dataset.id,a=this.getDataById(e);this.selectedRowdata=a,this.renderModalEdit(a)}))}))},tably.prototype.getDataById=function(t){return this.filteredData.find((e=>e.id===t))},tably.prototype.setDataById=function(t,e){var a=this.table.querySelector('tr[data-id="'+t+'"]');if(a){a.querySelectorAll("td[data-key]");for(var n=Object.keys(e),o=0;o<n.length;o++){var s=n[o],i=a.querySelector('td[data-key="'+s+'"]');if(i){var r=e[s];i.innerText=r||""}}}},tably.prototype.CreateHeaderToolbar=function(t){if(!this.hideSearch&&this.options.enableSearch){const e=document.createElement("div");e.className="tably-header-toolbar";const a=document.createElement("input");a.type="text",a.placeholder="Search...",a.className="tably-table-search",a.addEventListener("input",(t=>{this.filterData(null,t.target.value,!0)})),this.customHeaderButtons.forEach((t=>{const a=document.createElement("button");a.innerHTML=t.icon?`<i class="${t.icon}"></i> `:"",a.innerHTML+=t.text,a.title=t.title?t.title:"",a.className=`btn ${t.className||"btn-secondary btn-sm "} mr-2`,a.addEventListener("click",t.action),e.appendChild(a)})),e.appendChild(a),t.appendChild(e)}},tably.prototype.render=function(t){const e=document.querySelector(t);this.tableContainer=document.createElement("div"),this.tableContainer.className="tably",this.CreateHeaderToolbar(this.tableContainer);const a=document.createElement("div");a.className="tably-table-wrapper",a.appendChild(this.table),this.tableContainer.appendChild(a),this.tableContainer.appendChild(this.footer),e.appendChild(this.tableContainer)},tably.prototype.test=function(){const t=[];function e(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let a=0;a<5;a++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}for(let a=0;a<100;a++){const n={};n.id=e();for(let t=1;t<10;t++)n["Column"+(t+1)]=a.toString()+e();t.push(n)}return t};